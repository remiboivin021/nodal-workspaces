name: ADR Automation Workflow

on:
  issues:
    types: [opened, labeled, edited]
  discussion_comment:
    types: [created]
  discussion:
    types: [closed]

jobs:
  detect-and-create-discussion:
    name: Detect ADR need and create discussion
    runs-on: ubuntu-latest
    if: github.event_name == 'issues' && (github.event.action == 'opened' || github.event.action == 'labeled')
    
    permissions:
      issues: write
      discussions: write
      contents: write
    #   contents: read
    
    steps:
      - name: Check if already has discussion
        id: check_existing
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            
            // V√©rifier si une discussion existe d√©j√† pour cette issue
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number
            });
            
            const hasDiscussion = comments.data.some(c => 
              c.user.type === 'Bot' && 
              c.body.includes('üèõÔ∏è **ADR Discussion Created**')
            );
            
            return !hasDiscussion;
      
      - name: Analyze if ADR is needed
        if: fromJSON(steps.check_existing.outputs.result)
        id: analyze
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            
            // Crit√®res de d√©tection d'un ADR
            const hasADRLabel = issue.labels.some(l => 
              ['adr', 'architecture', 'design-decision'].includes(l.name.toLowerCase())
            );
            
            const adrKeywords = [
              'architecture', 'architectural', 'design decision',
              'adr', 'technical decision', 'system design',
              'refactor', 'redesign', 'architectural choice'
            ];
            
            const titleLower = issue.title.toLowerCase();
            const bodyLower = (issue.body || '').toLowerCase();
            
            const hasKeywords = adrKeywords.some(kw => 
              titleLower.includes(kw) || bodyLower.includes(kw)
            );
            
            const isADR = hasADRLabel || hasKeywords;
            
            console.log(`Issue #${issue.number}: ADR detection = ${isADR}`);
            console.log(`  - Has ADR label: ${hasADRLabel}`);
            console.log(`  - Has keywords: ${hasKeywords}`);
            
            return {
              isADR: isADR,
              issueNumber: issue.number,
              issueTitle: issue.title,
              issueBody: issue.body || ''
            };
      
      - name: Get discussion category ID
        if: fromJSON(steps.check_existing.outputs.result) && fromJSON(steps.analyze.outputs.result).isADR
        id: get_category
        uses: actions/github-script@v7
        with:
          script: |
            // R√©cup√©rer toutes les cat√©gories de discussion
            const result = await github.graphql(`
              query($owner: String!, $repo: String!) {
                repository(owner: $owner, name: $repo) {
                  discussionCategories(first: 20) {
                    nodes {
                      id
                      name
                    }
                  }
                }
              }
            `, {
              owner: context.repo.owner,
              repo: context.repo.repo
            });
            
            const categories = result.repository.discussionCategories.nodes;
            
            console.log('üìã Available discussion categories:');
            categories.forEach(cat => {
              console.log(`  - ${cat.name}: ${cat.id}`);
            });
            
            // Chercher la cat√©gorie "Architecture Decisions" (ou variantes)
            const possibleNames = [
              'Architecture Decisions',
              'Architecture Decision Records',
              'ADR',
              'Architectural Decisions',
              'architecture decisions',
              'adr'
            ];
            
            let category = categories.find(cat => 
              possibleNames.some(name => 
                cat.name.toLowerCase() === name.toLowerCase()
              )
            );
            
            // Si pas trouv√©e, utiliser la premi√®re cat√©gorie disponible
            if (!category && categories.length > 0) {
              category = categories[0];
              console.log(`‚ö†Ô∏è  No "Architecture Decisions" category found, using: ${category.name}`);
            }
            
            if (!category) {
              throw new Error('No discussion categories found! Please create at least one discussion category in your repository.');
            }
            
            console.log(`‚úÖ Using category: ${category.name} (${category.id})`);
            
            return {
              categoryId: category.id,
              categoryName: category.name
            };

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      # 3. R√©cup√©rer les commentaires de la discussion
      - name: Fetch discussion comments
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const discussion_number = context.payload.discussion.number;

            const comments = await github.paginate(
              github.rest.discussions.listComments,
              {
                owner: context.repo.owner,
                repo: context.repo.repo,
                discussion_number
              }
            );

            const enriched = [];
            for (const c of comments) {
              // R√©cup√®re le r√¥le GitHub de l'utilisateur
              const perm = await github.rest.repos.getCollaboratorPermissionLevel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                username: c.user.login
              });

              enriched.push({
                id: c.id,
                body: c.body,
                author: c.user.login,
                author_role: perm.data.permission.toUpperCase(), // ADMIN / MAINTAIN / WRITE / READ
                created_at: c.created_at
              });
            }

            const payload = {
              meta: {
                issue_number: discussion_number,
                discussion_url: context.payload.discussion.html_url,
                title: context.payload.discussion.title
              },
              comments: enriched
            };

            require("fs").writeFileSync("input.json", JSON.stringify(payload, null, 2));
            console.log("Saved discussion comments to input.json");

      # 4. Installer d√©pendances Python si n√©cessaire
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip

      # 5. Ex√©cuter le script ADR bot
      - name: Run ADR bot
        run: |
          python adr_bot/main.py input.json

      # 6. Commit et push des fichiers ADR g√©n√©r√©s
      - name: Commit ADR
        if: success()
        run: |
          git config user.name "adr-bot"
          git config user.email "adr-bot@users.noreply.github.com"
          git add docs/adr/*.md adr_state.json || true
          git commit -m "docs(adr): publish ADR" || true
          git push

      - name: Handle rejection or no approval
        if: "!fromJSON(steps.check_approval.outputs.result).shouldGenerate"
        uses: actions/github-script@v7
        with:
          script: |
            await github.graphql(`
              mutation($discussionId: ID!, $body: String!) {
                addDiscussionComment(input: {
                  discussionId: $discussionId,
                  body: $body
                }) {
                  comment { id }
                }
              }
            `, {
              discussionId: context.payload.discussion.node_id,
              body: `‚ÑπÔ∏è **No ADR Generated**
            
            This discussion was closed without approval (\`/adr approve\` command).
            
            No ADR document will be created.`
            });