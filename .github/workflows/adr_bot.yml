name: ADR Bot

on:
  discussion_comment:
    types: [created]

permissions:
  contents: write
  discussions: write

jobs:
  adr:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Fetch discussion comments
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const discussionNumber = context.payload.discussion.number;

            const query = `
              query($owner: String!, $repo: String!, $number: Int!) {
                repository(owner: $owner, name: $repo) {
                  discussion(number: $number) {
                    comments(first: 100) {
                      nodes {
                        body
                        createdAt
                        author {
                          login
                        }
                      }
                    }
                  }
                }
              }
            `;

            const result = await github.graphql(query, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              number: discussionNumber
            });

            const comments = result.repository.discussion.comments.nodes;

            const enriched = [];

            let role = "BOT";

            if (c.author.login !== "github-actions") {
              try {
                const perm = await github.rest.repos.getCollaboratorPermissionLevel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  username: c.author.login
                });
                role = perm.data.permission.toUpperCase();
              } catch (e) {
                console.log(`⚠️ Unable to get role for ${c.author.login}, defaulting to READ`);
                role = "READ";
              }
            }

            enriched.push({
              body: c.body,
              author: c.author.login,
              author_role: role,
              created_at: c.createdAt
            });
            require("fs").writeFileSync(
              "input.json",
              JSON.stringify({ meta: {}, comments: enriched }, null, 2)
            );

            console.log(`Fetched ${enriched.length} discussion comments`);

      - name: Run ADR bot
        run: |
          python scripts/adr_bot/main.py input.json
      - name: Post ADR bot feedback
        if: always()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require("fs");
            if (!fs.existsSync("bot_output.json")) {
              console.log("No bot output to post");
              return;
            }

            const output = JSON.parse(fs.readFileSync("bot_output.json", "utf8"));

            let body = "";
            if (output.status === "error") {
              body = `❌ **ADR command failed**\n\n${output.message}`;
              if (output.details?.missing) {
                body += `\n\n**Missing required sections:**\n- ${output.details.missing.join("\n- ")}`;
              }
            } else {
              body = `✅ **ADR approved**\n\nGenerated file: \`${output.adr_file}\``;
            }

            const mutation = `
              mutation($discussionId: ID!, $body: String!) {
                addDiscussionComment(input: {
                  discussionId: $discussionId,
                  body: $body
                }) {
                  comment {
                    id
                  }
                }
              }
            `;

            await github.graphql(mutation, {
              discussionId: context.payload.discussion.node_id,
              body
            });

            console.log("ADR bot feedback posted");

      - name: Commit ADR
        if: success()
        run: |
          git config user.name "adr-bot"
          git config user.email "adr-bot@users.noreply.github.com"
          git add docs/adr/*.md adr_state.json || true
          git commit -m "docs(adr): publish ADR" || true
          git push
